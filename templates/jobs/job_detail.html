{% extends 'base.html' %}

{% block title %}{{ job.title }} at {{ job.company.name }} - JobVista{% endblock %}

{% block content %}
<div class="w-full px-4 sm:px-6 lg:px-8 py-8" style="background: radial-gradient(1600px 900px at -10% -20%, #EEF2FF, transparent), radial-gradient(1400px 800px at 120% 0%, #F5F7FF, transparent);">
  <div class="max-w-7xl mx-auto">
    <nav class="mb-6">
      <ol class="flex items-center space-x-2 text-sm text-gray-500">
        <li><a href="{% url 'home' %}" class="hover:text-blue-600">Jobs</a></li>
        <li><i class="fas fa-chevron-right text-xs"></i></li>
        <li><a href="{% url 'home' %}?category={{ job.category.slug }}" class="hover:text-blue-600">{{ job.category.name }}</a></li>
        <li><i class="fas fa-chevron-right text-xs"></i></li>
        <li class="font-medium" style="color: var(--text-heading);">{{ job.title|truncatechars:35 }}</li>
      </ol>
    </nav>

    <div class="flex flex-col lg:flex-row gap-8">
      <div class="lg:w-2/3">
        <div class="backdrop-blur bg-white/60 border rounded-2xl p-8 mb-6 card-shadow" style="border-color: #ffffff33;">
          <div class="flex items-start gap-6">
            {% if job.company.logo %}
              <img src="{{ job.company.logo.url }}" class="w-16 h-16 rounded-lg object-contain border bg-white p-1" style="border-color: var(--border);" alt="{{ job.company.name }}"/>
            {% else %}
              <div class="w-16 h-16 rounded-lg border flex items-center justify-center text-gray-400 bg-white" style="border-color: var(--border);"><i class="fas fa-building text-2xl"></i></div>
            {% endif %}
            <div class="flex-1">
              <h1 class="text-3xl font-bold mb-1" style="color: var(--text-heading);">{{ job.title }}</h1>
              <p class="text-lg text-gray-700">{{ job.company.name }}</p>
            </div>
            {% if user.is_authenticated %}
              <button onclick="toggleBookmark('{{ job.id }}')" id="bookmark-btn-{{ job.id }}" class="p-3 text-gray-400 transition duration-300 border rounded-lg hover:bg-white/80" style="border-color: var(--border);">
                <i class="fas fa-heart text-2xl {% if is_bookmarked %}text-red-500{% endif %}"></i>
              </button>
            {% endif %}
          </div>
          <div class="border-t my-6" style="border-color: var(--border);"></div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div class="flex items-center gap-2"><i class="fas fa-map-marker-alt text-gray-400"></i><span class="font-medium text-gray-700">{{ job.location }}</span></div>
            <div class="flex items-center gap-2"><i class="fas fa-briefcase text-gray-400"></i><span class="font-medium text-gray-700">{{ job.get_employment_type_display }}</span></div>
            <div class="flex items-center gap-2"><i class="fas fa-layer-group text-gray-400"></i><span class="font-medium text-gray-700">{{ job.get_experience_level_display }}</span></div>
            {% if job.salary_min or job.salary_max %}
            <div class="flex items-center gap-2"><i class="fas fa-rupee-sign text-gray-400"></i><span class="font-medium text-green-700">₹{{ job.salary_min|floatformat:0 }} – {{ job.salary_max|floatformat:0 }}</span></div>
            {% endif %}
          </div>
        </div>

        <div class="backdrop-blur bg-white/60 border rounded-2xl card-shadow" style="border-color: #ffffff33;">
          <div class="border-b p-2" style="border-color: var(--border);">
            <nav class="flex space-x-2" aria-label="Tabs">
              <a href="#" class="job-tab-button active-tab" data-target="tab-description">Description</a>
              <a href="#" class="job-tab-button" data-target="tab-requirements">Requirements</a>
              <a href="#" class="job-tab-button" data-target="tab-responsibilities">Responsibilities</a>
            </nav>
          </div>
          <div class="p-8">
            <div id="tab-description" class="job-tab-content prose max-w-none text-gray-800">
              {{ job.description|linebreaks }}
            </div>
            <div id="tab-requirements" class="job-tab-content hidden prose max-w-none text-gray-800">
              {{ job.requirements|linebreaks }}
            </div>
            <div id="tab-responsibilities" class="job-tab-content hidden prose max-w-none text-gray-800">
              {{ job.responsibilities|linebreaks }}
            </div>
          </div>
        </div>
      </div>

      <div class="lg:w-1/3">
        <div class="lg:sticky top-24 space-y-6">
          <div class="backdrop-blur bg-white/60 border rounded-2xl p-6 card-shadow" style="border-color: #ffffff33;">
            {% if job.match_score %}
            <div class="text-center mb-4">
                <p class="text-sm text-gray-600">Your AI Match Score</p>
                <p class="text-4xl font-bold" style="color: var(--color-primary);">✨ {{ job.match_score }}%</p>
            </div>
            {% endif %}

            {% if job.is_expired %}
              <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm text-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>This job posting has expired.
              </div>
            {% else %}
              <a href="{% url 'apply_job' slug=job.slug %}" class="w-full text-center px-4 py-3 rounded-lg btn-primary-brand font-semibold">
                Apply Now <i class="fas fa-arrow-right ml-1"></i>
              </a>
              {% if user.is_authenticated %}
                <button onclick="toggleBookmark('{{ job.id }}')" id="bookmark-btn-sidebar-{{ job.id }}" class="mt-3 w-full border text-gray-700 py-2.5 px-4 rounded-lg btn-secondary-brand font-medium">
                  <i class="fas fa-heart mr-2 {% if is_bookmarked %}text-red-500{% endif %}"></i>
                  <span class="bookmark-text">{% if is_bookmarked %}Remove from{% else %}Save to{% endif %} Bookmarks</span>
                </button>
              {% endif %}
            {% endif %}
          </div>

          <div class="backdrop-blur bg-white/60 border rounded-2xl p-6 card-shadow" style="border-color: #ffffff33;">
            <h3 class="text-lg font-semibold mb-4" style="color: var(--text-heading);">About {{ job.company.name }}</h3>
            <div class="space-y-3 text-sm">
                <div class="flex gap-3"><i class="fas fa-map-marker-alt text-gray-400 w-4 text-center"></i><span class="text-gray-700">{{ job.company.location|default:"Not specified" }}</span></div>
                <div class="flex gap-3"><i class="fas fa-users text-gray-400 w-4 text-center"></i><span class="text-gray-700">{{ job.company.get_company_size_display|default:"Not specified" }}</span></div>
                {% if job.company.website %}
                <div class="flex gap-3">
                    <i class="fas fa-globe text-gray-400 w-4 text-center"></i>
                    <a href="{{ job.company.website }}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline truncate">{{ job.company.website|slice:":30" }}{% if job.company.website|length > 30 %}...{% endif %}</a>
                </div>
                {% endif %}
            </div>
            {% if job.company.description %}
            <p class="text-sm text-gray-600 mt-4 pt-4 border-t" style="border-color: var(--border);">{{ job.company.description|truncatewords:25 }}</p>
            {% endif %}
          </div>
          
          {% if related_jobs %}
            <div class="backdrop-blur bg-white/60 border rounded-2xl p-6 card-shadow" style="border-color: #ffffff33;">
              <h3 class="text-lg font-semibold mb-4" style="color: var(--text-heading);">Similar Jobs</h3>
              <div class="space-y-4">
                {% for related_job in related_jobs %}
                  <div>
                    <a href="{{ related_job.get_absolute_url }}" class="font-semibold text-sm hover:text-blue-600" style="color: var(--text-heading);">{{ related_job.title }}</a>
                    <p class="text-xs text-gray-500">{{ related_job.company.name }} • {{ related_job.location }}</p>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.04), 0 2px 4px -2px rgb(0 0 0 / 0.04); }
.job-tab-button {
  padding: 8px 16px;
  border-radius: 6px;
  font-weight: 500;
  color: #4B5563; /* text-gray-600 */
  transition: all 0.2s ease-in-out;
}
.job-tab-button:hover { background-color: rgba(255,255,255,0.5); }
.job-tab-button.active-tab {
  background-color: #FFFFFF;
  color: var(--color-primary);
  font-weight: 600;
  box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
}
</style>

<script>
// Bookmark functionality
function toggleBookmark(jobId) {
    const mainBtn = document.getElementById(`bookmark-btn-${jobId}`);
    const mainIcon = mainBtn ? mainBtn.querySelector('i') : null;
    const sidebarBtn = document.getElementById(`bookmark-btn-sidebar-${jobId}`);
    const sidebarIcon = sidebarBtn ? sidebarBtn.querySelector('i') : null;
    const sidebarText = sidebarBtn ? sidebarBtn.querySelector('.bookmark-text') : null;
    
    // In a real app, you would get the CSRF token from a cookie or meta tag
    const csrftoken = '{{ csrf_token }}';

    fetch(`/bookmarks/bookmark/${jobId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        const isBookmarked = data.bookmarked;
        const elements = [[mainIcon, null], [sidebarIcon, sidebarText]];
        elements.forEach(([icon, textEl]) => {
            if (icon) {
                icon.classList.toggle('text-red-500', isBookmarked);
            }
            if (textEl) {
                textEl.textContent = isBookmarked ? 'Remove from Bookmarks' : 'Save to Bookmarks';
            }
        });
    })
    .catch(error => console.error('Error:', error));
}

// Job Details Tab functionality
const jobTabButtons = document.querySelectorAll('.job-tab-button');
const jobTabContents = document.querySelectorAll('.job-tab-content');
jobTabButtons.forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        jobTabButtons.forEach(btn => btn.classList.remove('active-tab'));
        button.classList.add('active-tab');
        const targetId = button.getAttribute('data-target');
        jobTabContents.forEach(content => {
            content.classList.toggle('hidden', content.id !== targetId);
        });
    });
});
</script>
{% endblock %}